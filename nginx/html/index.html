<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="img/png" href="/img/icons8-glass-32.png">
    <title>Sistema de Logs</title>
    <style>
        :root {
            /* Cores System iOS Dark Mode */
            --ios-blue: #0A84FF;
            --ios-indigo: #5E5CE6;
            --ios-green: #30D158;
            --ios-red: #FF453A;
            --ios-gray: #8E8E93;
            --ios-bg: #000000;
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(30, 30, 30, 0.45);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --blur-amt: 25px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Ambient Background (Blobs) */
        body::before, body::after {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.4;
            animation: float 20s infinite alternate;
        }

        body::before {
            background: radial-gradient(circle, var(--ios-blue), transparent);
            top: -10%;
            left: -10%;
        }

        body::after {
            background: radial-gradient(circle, var(--ios-indigo), transparent);
            bottom: -10%;
            right: -10%;
            animation-delay: -10s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Glass Utility Class */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur-amt));
            -webkit-backdrop-filter: blur(var(--blur-amt));
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 20px;
        }

        /* Header */
        header {
            margin-bottom: 40px;
            text-align: left;
            padding: 0 10px;
        }

        header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        header p {
            color: var(--ios-gray);
            font-size: 1.1rem;
            font-weight: 400;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease, background 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            background: rgba(45, 45, 45, 0.55);
        }

        .stat-card p {
            color: var(--ios-gray);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-card h3 {
            font-size: 2.4rem;
            font-weight: 600;
            color: #fff;
            letter-spacing: -1px;
        }

        /* Section Container */
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Controls Area (Search) */
        .controls-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 10px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 12px;
            flex: 1;
            max-width: 800px;
            justify-content: flex-end;
        }

        /* iOS Style Inputs */
        input[type="text"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
            width: 100%;
            min-width: 200px;
        }

        input[type="text"]:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* iOS Style Buttons */
        button {
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--ios-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #0071e3;
            transform: scale(1.02);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Table Styling */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }

        thead th {
            background: rgba(0, 0, 0, 0.3);
            color: var(--ios-gray);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        tbody tr {
            transition: background 0.1s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        /* Compact Rows */
        td {
            padding: 8px 16px; /* Mais compacto */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #e5e5e5;
            vertical-align: middle;
        }

        /* Mono fonts for technical data */
        .font-mono {
            font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
            font-size: 0.85rem;
            opacity: 0.9;
            letter-spacing: -0.5px;
        }

        .badge-id {
            color: var(--ios-gray);
            font-size: 0.8rem;
        }

        .badge-mac {
            color: #a2d2ff;
        }

        .badge-cpf {
            color: #fff;
            font-weight: 500;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
            color: var(--ios-gray);
            font-size: 0.9rem;
        }

        .pagination button {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: default;
        }

        .loading, .error {
            padding: 40px;
            text-align: center;
            color: var(--ios-gray);
        }

        .error { color: var(--ios-red); }

        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
                max-width: 100%;
            }
            .controls-area {
                flex-direction: column;
                align-items: flex-start;
            }
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Monitoramento de Logs</h1>
            <p>Visão geral do tráfego e acesso do sistema em tempo real</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card glass-panel">
                <p>Total de Registros</p>
                <h3 id="stat-total">-</h3>
            </div>
            <div class="stat-card glass-panel">
                <p>Usuários Únicos (CPF)</p>
                <h3 id="stat-cpfs" style="color: var(--ios-blue)">-</h3>
            </div>
            <div class="stat-card glass-panel">
                <p>Dispositivos (MAC)</p>
                <h3 id="stat-macs" style="color: var(--ios-indigo)">-</h3>
            </div>
            <div class="stat-card glass-panel">
                <p>Atividade (24h)</p>
                <h3 id="stat-24h" style="color: var(--ios-green)">-</h3>
            </div>
        </div>

        <div class="glass-panel main-content">
            
            <div class="controls-area">
                <div class="section-title">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    <span>Registro de Acessos</span>
                </div>
                
                <div class="search-box">
                    <input type="text" id="search-cpf" placeholder="Buscar por CPF (000.000...)">
                    <input type="text" id="search-mac" placeholder="Buscar por MAC Address">
                    <button class="btn-primary" onclick="searchLogs()">Buscar</button>
                    <button class="btn-secondary" onclick="clearSearch()">Limpar</button>
                </div>
            </div>

            <div id="logs-container" class="table-wrapper">
                <div class="loading">Sincronizando dados...</div>
            </div>

            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentPage = 1;
        const limit = 20;

        // --- CARREGAR ESTATÍSTICAS ---
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/logs/stats`);
                const data = await response.json();
                
                document.getElementById('stat-total').textContent = formatNumber(data.total_logs);
                document.getElementById('stat-cpfs').textContent = formatNumber(data.cpfs_unicos);
                document.getElementById('stat-macs').textContent = formatNumber(data.macs_unicos);
                document.getElementById('stat-24h').textContent = formatNumber(data.logs_ultimas_24h);
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // --- CARREGAR LOGS (PAGINAÇÃO) ---
        async function loadLogs(page = 1) {
            currentPage = page;
            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="loading">Carregando dados...</div>';

            try {
                const response = await fetch(`${API_BASE}/logs?page=${page}&limit=${limit}`);
                const data = await response.json();
                
                // Mapeia data.data pois é o formato padrão da sua API original
                renderLogsTable(data.data);
                renderPagination(data.pagination);
            } catch (error) {
                container.innerHTML = '<div class="error">Falha na conexão com o servidor.</div>';
                console.error(error);
            }
        }

        // --- BUSCA ---
        async function searchLogs() {
            const cpf = document.getElementById('search-cpf').value.trim();
            const mac = document.getElementById('search-mac').value.trim();

            if (!cpf && !mac) {
                loadLogs(1);
                return;
            }

            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="loading">Buscando...</div>';

            try {
                const params = new URLSearchParams();
                if (cpf) params.append('cpf', cpf);
                if (mac) params.append('mac', mac);

                const response = await fetch(`${API_BASE}/logs/search?${params}`);
                const data = await response.json();
                
                renderLogsTable(data.data);
                // Ajuste simples para mostrar total na paginação de busca
                document.getElementById('pagination').innerHTML = 
                    `<span style="color: var(--ios-gray)">Encontrados: ${data.count || data.data.length} registros</span>`;
            } catch (error) {
                container.innerHTML = '<div class="error">Erro na busca.</div>';
            }
        }

        // --- LIMPAR BUSCA ---
        function clearSearch() {
            document.getElementById('search-cpf').value = '';
            document.getElementById('search-mac').value = '';
            loadLogs(1);
        }

        // --- RENDERIZAR TABELA ---
        function renderLogsTable(logs) {
            const container = document.getElementById('logs-container');
            
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="loading">Nenhum registro encontrado.</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 80px">ID</th>
                            <th>CPF do Usuário</th>
                            <th>Endereço MAC</th>
                            <th style="text-align: right">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            logs.forEach(log => {
                html += `
                    <tr>
                        <td><span class="badge-id font-mono">#${log.id}</span></td>
                        <td><span class="badge-cpf font-mono">${formatCPF(log.cpf)}</span></td>
                        <td><span class="badge-mac font-mono">${log.mac_address}</span></td>
                        <td style="text-align: right; color: var(--ios-gray); font-size: 0.8rem;">
                            ${formatDate(log.horario)}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- RENDERIZAR PAGINAÇÃO ---
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            const { page, totalPages, total } = pagination;

            container.innerHTML = `
                <button onclick="loadLogs(${page - 1})" ${page <= 1 ? 'disabled' : ''}>Anterior</button>
                <span>Página ${page} de ${totalPages}</span>
                <button onclick="loadLogs(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>Próxima</button>
            `;
        }

        // --- FORMATADORES ---
        function formatNumber(num) {
            return new Intl.NumberFormat('pt-BR').format(num || 0);
        }

        function formatCPF(cpf) {
            if (!cpf) return '-';
            const digits = cpf.replace(/\D/g, '');
            if (digits.length === 11) {
                return `${digits.slice(0,3)}.${digits.slice(3,6)}.${digits.slice(6,9)}-${digits.slice(9)}`;
            }
            return cpf;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit', month: '2-digit', year: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            }).format(date);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('search-cpf').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLogs();
        });
        document.getElementById('search-mac').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLogs();
        });

        // --- INICIALIZAÇÃO ---
        loadStats();
        loadLogs(1);

        // Atualização automática a cada 30s
        setInterval(() => {
            loadStats();
        }, 30000);

    </script>
</body>
</html>